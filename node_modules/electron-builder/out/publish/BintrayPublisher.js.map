{
  "version": 3,
  "file": "BintrayPublisher.js",
  "sourceRoot": "",
  "sources": [
    "../../src/publish/BintrayPublisher.ts"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "import { Publisher, PublishOptions } from \"./publisher\"\nimport BluebirdPromise from \"bluebird-lst-c\"\nimport { log } from \"../util/log\"\nimport { debug, isEmptyOrSpaces } from \"../util/util\"\nimport { BintrayClient, Version } from \"electron-builder-http/out/bintray\"\nimport { BintrayOptions } from \"electron-builder-http/out/publishOptions\"\nimport { ClientRequest } from \"http\"\nimport { NodeHttpExecutor } from \"../util/nodeHttpExecutor\"\nimport { HttpError } from \"electron-builder-http\"\n\nexport class BintrayPublisher extends Publisher {\n  private _versionPromise: BluebirdPromise<Version>\n  private readonly httpExecutor: NodeHttpExecutor = new NodeHttpExecutor()\n\n  private readonly client: BintrayClient\n\n  constructor(info: BintrayOptions, private readonly version: string, private readonly options: PublishOptions = {}) {\n    super()\n\n    let token = info.token\n    if (isEmptyOrSpaces(token)) {\n      token = process.env.BT_TOKEN\n      if (isEmptyOrSpaces(token)) {\n        throw new Error(`Bintray token is not set, neither programmatically, nor using env \"BT_TOKEN\"`)\n      }\n    }\n\n    this.client = new BintrayClient(info, token)\n    this._versionPromise = <BluebirdPromise<Version>>this.init()\n  }\n\n  private async init(): Promise<Version | null> {\n    try {\n      return await this.client.getVersion(this.version)\n    }\n    catch (e) {\n      if (e instanceof HttpError && e.response.statusCode === 404) {\n        if (this.options.publish !== \"onTagOrDraft\") {\n          log(`Version ${this.version} doesn't exist, creating one`)\n          return this.client.createVersion(this.version)\n        }\n        else {\n          log(`Version ${this.version} doesn't exist, artifacts will be not published`)\n        }\n      }\n\n      throw e\n    }\n  }\n\n  protected async doUpload(fileName: string, dataLength: number, requestProcessor: (request: ClientRequest, reject: (error: Error) => void) => void) {\n    const version = await this._versionPromise\n    if (version == null) {\n      debug(`Version ${this.version} doesn't exist and is not created, artifact ${fileName} is not published`)\n      return\n    }\n\n    let badGatewayCount = 0\n    for (let i = 0; i < 3; i++) {\n      try {\n        return await this.httpExecutor.doApiRequest<any>({\n          hostname: \"api.bintray.com\",\n          path: `/content/${this.client.owner}/${this.client.repo}/${this.client.packageName}/${version.name}/${fileName}`,\n          method: \"PUT\",\n          headers: {\n            \"User-Agent\": \"electron-builder\",\n            \"Content-Length\": dataLength,\n            \"X-Bintray-Override\": \"1\",\n            \"X-Bintray-Publish\": \"1\",\n          }\n        }, this.client.auth, requestProcessor)\n      }\n      catch (e) {\n        if (e instanceof HttpError && e.response.statusCode === 502 && badGatewayCount++ < 3) {\n          continue\n        }\n\n        throw e\n      }\n    }\n  }\n\n  //noinspection JSUnusedGlobalSymbols\n  deleteRelease(): Promise<any> {\n    if (!this._versionPromise.isFulfilled()) {\n      return BluebirdPromise.resolve()\n    }\n\n    const version = this._versionPromise.value()\n    return version == null ? BluebirdPromise.resolve() : this.client.deleteVersion(version.name)\n  }\n}"
  ]
}
